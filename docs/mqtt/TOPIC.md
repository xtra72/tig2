# MQTT Topic 나무의 설계 지침서

( 2019년 5월부터 ~ )

[[_TOC_]]

## 공통

- 나무 구조에서 토픽은 뿌리에서 잎에 다다르는 경로로 생각
- 각 단계는 소문자, 숫자, - 만으로
  - 대소문자를 구분하기때문에 오탈자 문제가 일어나기 쉽다.
- 단계별 구조는 점점 더 좁혀지면서 또렷해지는 모양으로 (뿌리에서 잎으로)
  - 이를 테면, 뭔서비스/어느건물/몇층/몇번방/집중기/온도/센서
- 경로(routing) 정보가 고스란히 포함되도록
  - 뿌리에서 잎을 찾아갈 수 있도록, 경로 데이터를 이용하기 좋게끔
- 데이터 메시지와 명령 메시지를 따로 처리할 수 있도록
  - 첫 단계 토픽으로 계측과 명령을 구분지어서 수동적으로 원격 기기에서 계측된
    데이터를 다루는 것과 능동적으로 원격 기기를 제어하는 데이터를 구분하는 것이
    서비스 정책에 따라 권한 설정 따위를 세밀하게 조절하는데 유리
- 토픽 구조가 운영 지침의 일부가 되게끔 상세하게 기록
  - 토픽으로 오가는 데이터를 누가 만들고 누가 쓰는지 곧 대상, 의도, 목적 따위와
    함께 데이터의 게시, 구독, 수신에 쓰이는 모든 토픽을 나열하고 각 데이터의 제약
    사항, 한계치 (범위), 보안, 용도 따위도 세밀하게 명시
- 장치가 데이터를 게시하고 구독하는 토픽에 그 장치의 고유한 이름을 포함
  - 특정 장치가 메시지를 게시하거나 특정 장치로 메시지를 전송하는 경우 메시지 속에 그 장치의 고유한 이름을 포함
  - 토픽 경로의 (끝자락 또는) 마지막 단계에 장치의 고유 이름이 나오도록
- 메시지 Payload에 특정 메시지의 맥락을 설명하는 정보를 추가할 것
  - 세션 ID, 로깅 정보, 응답 데이터를 받을 토픽 이름 같은 것들
  - 나중에 장치의 동작 방식을 분석하여 그 경항을 추적하는 따위에 쓰일 정보의
      표준 스키마를 정의해 두는 것이 유용

## 원격측정(Telemetry)을 위한 토픽 설계

- 장치에서 전송한 자료를 수집하는 통신 방식
- QoS > 0 설정이 없다면 ACK 없는 일방 통신으로 충분
- Amazon IoT 클라우드 서비스에서 권장하는 토픽 문법

  ```html
  data/<application>/<context>/.../<thing>/<data-type>
  ```

  1. data
      - 메시지가 데이터인지 명령인지 그 종류를 구분짓는 접두어
  2. application
      - 토픽 나무 전체를 아우를 수 있는 애플리케이션이나 게이트웨이 같은 통합 장치 이름
  3. context ~
      - 메시지에 대한 맥락(Context) 또는 환경에 대한 정보
      - 장치가 설치된 위치나 설정 정보
      - 여러 장치를 묶어서 다루어야 할 때, 그 묶음을 가리키는 이름
  4. thing
      - 메시지를 전송하는 장치 이름
  5. data-type
      - 장치가 여러 부품으로 이루어져 있고 특정 부품을 특정 토픽과 연결해서
      데이터를 측정해야 할 때 온도, 습도, 가속도, 위치 따위

### 사례 연구

- [L사 수질 관리 프로젝트에서 토픽 나무의 설계 사례](../cases/lottewp.md)

## 제어(명령, Command)를 위한 토픽 설계

- 장치의 상태를 바꾸는 명령을 내리고 제대로 수행되었는지 확답 받는 쌍방향 통신
- 원격측정(Telemetry)과 같이 단방향으로 대량 데이터를 전송하는 토픽과 구분지어
  다루는 것이 애플리케이션 설계,데이터 분석,보안,네트워크 부하 분산과 같은 여러
  면에서 바람직
- 장치 별로 토픽을 따로 두는 것이 바람직
  - 분,시,일 단위로 낮은 TPS(Transation per second)를 유지
  - 장치의 상태 파악에 도움되는 (연결성, 부품별 오류 따위) 정보를
    저장하여 status metric storage로 쓸 수 있도록 설계
  - Firmware 버전 정보
  - 메시지에 발신자 정보를 포함하여 추적이 가능하도록 설계
- 명령 토픽을 설계할 때는 아래 사실이 드러나도록
  - 명령을 주고 받는 양쪽
  - 명령이 잘 수행되었는지 아니라면 무슨 잘못(error)으로 그리
    되었는지 현 상태는 어떤지
- Amazon IoT 클라우드 서비스에서 권장하는 토픽 문법

  ```html
  command/<application>/<context>/<destination-id>/<request-type>
  command/<application>/<context>/<destination-id>/<response-type>
  ```

  1. command
     - 명령 토픽을 나타내는 접두사
  2. destination-id
     - 메시지를 받는 장치나 애플리케이션 이름
  3. request-type 또는 response-type
     - 단일 장치에 간단한 명령이 오가는 경우라면 토픽이름을 그냥 request 또는 response라고 써도 충분.
     - MQTT 명령 토픽을 오가는 메시지 payload 스키마에 포함할 데이터
       - session-id: 세션 이름
       1. 명령을 요청하는 쪽에서 request 토픽에 요청 메시지를 게시할 때 고유한 session-id를 메시지 payload에 포함
       2. 명령을 처리한 쪽에서 response 토픽에 응답 메시지를 게시할 때 동일한 session-id를 메시지 payload에 포함
       3. 명령이 처리 중인지, 완결된 후 성공인지 오류인지 따위의 상태 정보를 구분하고 추척하는데 사용
       - response-topic: 명령에 대한 응답 메시지를 게시할 토픽

## 참고 자료

------

1. [Designing MQTT Topics for AWS IoT Core](https://d1.awsstatic.com/whitepapers/Designing_MQTT_Topics_for_AWS_IoT_Core.pdf)
2. [SNON - The Sensor Network Object Notation](http://www.snon.org/)
